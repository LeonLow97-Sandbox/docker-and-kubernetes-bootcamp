# State Persistence

## Volumes

- To persist data processed by container, create a volume and place the data in the Volume.
- In Kubernetes, we can also attach volumes to Pod. Data generated by Pod is stored in Volumes.
- The volume needs a storage location, configure it to a path on the host.

![Kubernetes Volumes](./course_resources/diagrams/volumes.png)

```yaml
apiVersion: v1
kind: Pod
metadata:
	name: random-number-generator
spec:
	containers:
	- image: alpine
    name: alpine
    command: ["/bin/sh", "-c"]
    args: ["shuf -i 0-100 -n 1 >> /p[t/number.out;"]
    ## once the volume is created, we mount the volume so the container can access the data in the volume
    volumeMounts:
    - mountPath: /opt
      name: data-volume
  volumes:
  ## The following volume works on a single node for storing data, but does not work across multiple nodes
  - name: data-volume
    hostPath:
      path: /data # Directory on the node where data is stored
      type: Directory

## Alternatively, you can store volumes in AWS Elastic Block Store
  volumes:
  - name: data-volume
    awsElasticBlockStore:
      volumeID: <volume-id>
      fsType: ext4
```

## Persistent Volumes

- In the previous section, the volumes were created in the Pod definition file.
- However, it is better to maintain the volumes in a more central location, i.e., Persistent Volume Claims (PVC), so that an administrator can configure a large pool of storage and users can request persistent volumes from it.
- PVC is consists of Persistent Volumes (PV)

```yaml
## pv-definition.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-vol1
spec:
  accessModes:
    - ReadWriteOnce
    # - ReadOnlyMany
    # - ReadWriteMany
  capacity:
    storage: 1Gi ## amount of storage reserved for this PV, set to 1GB in this case

  ## volume location, stored in Node's local directory (NOT USED IN PRODUCTION)
  # hostPath:
  #   path: /tmp/data

  ## replace hostPath with one of the PV storage solutions, like AWS Elastic Block Store
  awsElasticBlockStore:
    volumeID: <volume_id>
    fsType: ext4
```

```sh
kubectl create -f pv-definition.yaml

kubectl get persistentvolume
kubectl get pv
```

## Persistent Volume Claims

- Make the storage available to a Node.
- PVC and PV are 2 separate objects in Kubernetes namespace.
- Administrator creates a set of PV, user creates PVC to use the storage.
- Once PVC is created, Kubernetes binds the PV to the PVC based on the requests and properties set on the volume.
- Every PVC is bound to the PV.
- During the binding process, Kubernetes looks for PV that has sufficient capacity as requested by the claim.
- Binding: (if don't match, PVC will not be bounded to PV)
  - Sufficient Capacity
  - Access Modes
  - Volume Modes
  - Storage Class
  - Selector
    - If there are multiple PV that can bind to the PVC, can use selectors in PVC to bind to labels in a PV.
- If there are no PVs available, PVC remains in a "Pending" state. Once PV is available, PVC will be bounded to the PV.
- When PVC is created, Kubernetes looks at the accessModes match, capacity requested sufficient.

```yaml
## pvc-definition.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: myclaim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
```

```sh
kubectl create -f pvc-definition.yaml

kubectl get persistentvolumeclaim
kubectl get pvc

kubectl delete persistentvolumeclaim myclaim
kubectl delete pvc myclaim
```

- What happens to PV when a PVC bounded to it is deleted?

  - By default, PV has `persistentVolumeReclaimPolicy: Retain` When a PVC bound to it is deleted, the PV will remain until it is manually deleted by the administrator and is not available for reuse by other claims.
  - `persistentVolumeReclaimPolicy: Delete`: When a PVC bound to it is deleted, the PV will be deleted as well to free up storage space.
  - `persistentVolumeReclaimPolicy: Recycle`: When a PVC bound to it is deleted, the PV will be scrubbed (data cleared) and made available for a new claim.

- Using PVCs in Pods
  - Once you create a PVC, use it in a Pod definition file by specifying the PVC Claim name under `persistentVolumeClaim` section in the volumes section.
  - The same is true for ReplicaSets or Deployments. Add this to the pod template section of a Deployment on ReplicaSet.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: mypod
spec:
  containers:
    - name: myfrontend
      image: nginx
      volumeMounts:
        - mountPath: '/var/www/html'
          name: mypd
  volumes:
    - name: mypd
      persistentVolumeClaim:
        claimName: myclaim
```

- Volume Types:
  - `azureDisk` is used to mount a Microsoft Azure Data Disk into a Pod
  - `hostPath` is used to mount a directory from the Node on which the Pod is running.
  - `emptyDir` is used to store data in a Pod only as long as that Pod is running on that node and when the Pod is deleted, the files are to be deleted as well.
  - `fc` is used to mount an existing Fibre channel volume into a Pod.

## Storage Classes

- Before PV is created, you must create disk on Google Cloud or other supported cloud platforms.
- **Static Provisioning**: In Kubernetes, static provisioning involves the administrator manually creating PersistentVolumes (PVs) which are then matched to PersistentVolumeClaims (PVCs) made by users.
- **Dynamic Provisioning**: In Kubernetes, dynamic provisioning allows the system to automatically create PersistentVolumes (PVs) based on user-defined PersistentVolumeClaims (PVCs) and StorageClasses.

```sh
gcloud beta compute disks create \
  --size 1GB
  --region us-ease1
  pd-disk
```

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-vol1
spec:
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 500Mi
  gcePersistentDisk:
    pdName: pd-disk
    fsType: ext4
```

- Storage Classes: resource that defines the specifications and parameters for dynamically provisioning PersistentVolumes (PVs)
- Example below is using GCP storage class

```yaml
# sc-definition.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: google-storage
provisioner: kubernetes.io/gce-pd
parameters:
  type: pd-standard
  replication-type: none

# pvc-definition.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: myclaim
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: google-storage ## specify the storage class in pvc definition file.
  resources:
    requests:
      storage: 500Mi
```

```sh
kubectl get storageclass
kubectl get sc
```